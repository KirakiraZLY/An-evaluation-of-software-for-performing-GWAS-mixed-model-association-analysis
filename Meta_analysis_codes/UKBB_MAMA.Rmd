---
title: "UKBB_MAMA"
author: "zly"
date: "2023-03-05"
output: html_document
---

```{r}
# library(GENESIS)
library(qqman)
library(tidyverse)
library(tidyr)
```

# PCA plot
```{r}

plinkPCA <- read_table2("data_prune_pca.eigenvec",
                        col_names = FALSE)
plinkPCA <- plinkPCA[,c(-1,-2)] # Remove first 2 columns
EigenValue <- scan("data_prune_pca.eigenval")
# view(EigenValue)
```

## Set Columns names
```{r}
names(plinkPCA)[1:ncol(plinkPCA)] <- paste0("PC", 1:(ncol(plinkPCA)))
```

## Percentage variance explained
```{r}
pve <- data.frame(PC = 1:20, pve = EigenValue / sum(EigenValue) * 100)
```

## Make plot
```{r}
ggplot(pve, aes(PC,pve)) +
  geom_bar(stat = "identity") +
  ylab("Percentage variance explained") +
  theme_light()
```

## Plot PCA
```{r}
ggplot(plinkPCA, aes(PC1,PC2)) +
  geom_point(size = 3) +
  coord_equal() +
  theme_light() +
  coord_equal() +
  theme_light() +
  xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
  ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)"))
```


## Lets divide population in two groups
```{r}
# (pop <- rep(c("A","B"), each = nrow(plinkPCA) / 2))  ## Naively regroup
# pop <- as.data.frame(pop)

# pop <- rbind(pop,"B") # Odd number, so add one value manually
# mypop = read_tsv("pop.txt", col_names = FALSE) # Read from file

iid = read_table2("data_qc.fam",
                        col_names = FALSE)

region = read_table2("ethnic.txt",col_names = TRUE)



plinkPCA$iid <- iid$X2
colnames(plinkPCA)[21] <- 'iid'
colnames(region)[1] <- 'iid'


plinkPCA1 <- merge(x = plinkPCA, y = region, by = "iid", all.x = TRUE)
plinkPCA1 <- plinkPCA1[,-c(23,24)]
colnames(plinkPCA1)[22] <- 'ethnic'
```

## Reset the ethnicity
vague
```{r}
# table(plinkPCA1$ethnic)
plinkPCA1$ethnic[plinkPCA1$ethnic == "1"] <- 'White'
plinkPCA1$ethnic[plinkPCA1$ethnic == "1001"] <- 'White'
plinkPCA1$ethnic[plinkPCA1$ethnic == "1002"] <- 'White'
plinkPCA1$ethnic[plinkPCA1$ethnic == "1003"] <- 'White'
plinkPCA1$ethnic[plinkPCA1$ethnic == "2"] <- 'Mixed'
plinkPCA1$ethnic[plinkPCA1$ethnic == "2001"] <- 'Mixed'
plinkPCA1$ethnic[plinkPCA1$ethnic == "2002"] <- 'Mixed'
plinkPCA1$ethnic[plinkPCA1$ethnic == "2003"] <- 'Mixed'
plinkPCA1$ethnic[plinkPCA1$ethnic == "2004"] <- 'Mixed'
plinkPCA1$ethnic[plinkPCA1$ethnic == "3"] <- 'Asian or Asian British(South, West, Central)'
plinkPCA1$ethnic[plinkPCA1$ethnic == "3001"] <- 'Asian or Asian British(South, West, Central)'
plinkPCA1$ethnic[plinkPCA1$ethnic == "3002"] <- 'Asian or Asian British(South, West, Central)'
plinkPCA1$ethnic[plinkPCA1$ethnic == "3003"] <- 'Asian or Asian British(South, West, Central)'
plinkPCA1$ethnic[plinkPCA1$ethnic == "3004"] <- 'Asian or Asian British(South, West, Central)'
plinkPCA1$ethnic[plinkPCA1$ethnic == "5"] <- 'Chinese'

plinkPCA1$ethnic[plinkPCA1$ethnic == "4"] <- 'Black or Black British'
plinkPCA1$ethnic[plinkPCA1$ethnic == "4001"] <- 'Black or Black British'
plinkPCA1$ethnic[plinkPCA1$ethnic == "4002"] <- 'Black or Black British'
plinkPCA1$ethnic[plinkPCA1$ethnic == "4003"] <- 'Black or Black British'
# plinkPCA1$ethnic[plinkPCA1$ethnic == "5"] <- 'Zhong Guo'


plinkPCA1$ethnic[plinkPCA1$ethnic == "-1"] <- 'NA'
plinkPCA1$ethnic[plinkPCA1$ethnic == "-3"] <- 'NA'
plinkPCA1$ethnic[plinkPCA1$ethnic == "6"] <- 'NA'
```


## Accuracy test
```{r}
# iid_1 <- iid$X1
region_1 <- merge(plinkPCA1,region,all.x = TRUE,by="iid")

region_1$ethnic[region_1$ethnic == "1"] <- 'White'
region_1$ethnic[region_1$ethnic == "1001"] <- 'White'
region_1$ethnic[region_1$ethnic == "1002"] <- 'White'
region_1$ethnic[region_1$ethnic == "1003"] <- 'White'
region_1$ethnic[region_1$ethnic == "2"] <- 'Mixed'
region_1$ethnic[region_1$ethnic == "2001"] <- 'Mixed'
region_1$ethnic[region_1$ethnic == "2002"] <- 'Mixed'
region_1$ethnic[region_1$ethnic == "2003"] <- 'Mixed'
region_1$ethnic[region_1$ethnic == "2004"] <- 'Mixed'
region_1$ethnic[region_1$ethnic == "3"] <- 'Asian or Asian British(South, West, Central)'
region_1$ethnic[region_1$ethnic == "3001"] <- 'Asian or Asian British(South, West, Central)'
region_1$ethnic[region_1$ethnic == "3002"] <- 'Asian or Asian British(South, West, Central)'
region_1$ethnic[region_1$ethnic == "3003"] <- 'Asian or Asian British(South, West, Central)'
region_1$ethnic[region_1$ethnic == "3004"] <- 'Asian or Asian British(South, West, Central)'
region_1$ethnic[region_1$ethnic == "5"] <- 'Chinese'
region_1$ethnic[region_1$ethnic == "4"] <- 'Black or Black British'
region_1$ethnic[region_1$ethnic == "4001"] <- 'Black or Black British'
region_1$ethnic[region_1$ethnic == "4002"] <- 'Black or Black British'
region_1$ethnic[region_1$ethnic == "4003"] <- 'Black or Black British'
# plinkPCA1$ethnic[plinkPCA1$ethnic == "5"] <- 'Zhong Guo'
region_1$ethnic[region_1$ethnic == "-1"] <- 'NA'
region_1$ethnic[region_1$ethnic == "-3"] <- 'NA'
region_1$ethnic[region_1$ethnic == "6"] <- 'NA'

region_1 <- subset(region_1, ethnic != 'NA')
plinkPCA2 <- merge(plinkPCA1,region_1,all.y = TRUE,by="iid")
# colnames(plinkPCA2)[ethnic.y] <- "ethnic"
# colnames(plinkPCA2)[43] <- 'ethnic'

# intersect(region_1$ethnic, plinkPCA2$ethnic)
```

```{r}
# ggplot(plinkPCA2, aes(PC1.x,PC2.x, color = ethnic.x)) +
#   geom_point(size = 3) +
#   coord_equal() +
#   theme_light() +
#   coord_equal() +
#   theme_light() +
#   xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
#   ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
#   labs(title = "PCA on population structure")
# 
# ggplot(region_1, aes(PC1,PC2, color = ethnic)) +
#   geom_point(size = 3) +
#   coord_equal() +
#   theme_light() +
#   coord_equal() +
#   theme_light() +
#   xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
#   ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
#   labs(title = "PCA on population structure")
```

```{r}
plinkPCA_kmeans <- read_table2("data_prune_pca.eigenvec",
                        col_names = FALSE)
plinkPCA_kmeans <- plinkPCA_kmeans[,-c(1,2)] # Remove first 2 columns
EigenValue <- scan("data_prune_pca.eigenval")

names(plinkPCA_kmeans)[1:ncol(plinkPCA_kmeans)] <- paste0("PC", 1:(ncol(plinkPCA_kmeans)))
pve <- data.frame(PC = 1:20, pve = EigenValue / sum(EigenValue) * 100)
```
```{r}
library(randomForest)
library(cluster)
set.seed(0)
```

Set a subset of PCA and predict
```{r}
plinkPCAsub <- plinkPCA_kmeans[,c('PC1','PC2')]

km = kmeans(plinkPCAsub, centers = 5)
# km$cluster
plinkPCA_kmeans$ethnic <- km$cluster
plinkPCA_kmeans$iid <- iid$X2
plinkPCA_kmeans_sub <- merge(plinkPCA_kmeans,region_1,all.y = TRUE,by="iid")
# colnames(plinkPCA_kmeans_sub, prefix = ethnic.x) <- "ethnic"
```


```{r}
ggplot(region_1, aes(PC1,PC2, color = ethnic)) +
  geom_point(size = 3) +
  coord_equal() +
  theme_light() +
  coord_equal() +
  theme_light() +
  xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
  ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
  labs(title = "PCA on population structure, real")
# plinkPCA$region <- region$X1
# # colnames(plinkPCA)[21] <- "pop"
# plinkPCA$col<- ifelse(plinkPCA$pop >= 0, 1, 0)
# plinkPCA$col<-as.factor(plinkPCA$col)

# plinkPCA1 <- subset(plinkPCA1, ethnic != 'NA')

# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Black or Black British"] <- 'White'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Mixed"] <- 'Mixed'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "White"] <- 'Asian or Asian British(Chinese included)'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Asian or Asian British(Chinese included)"] <- 'Black or Black British'
```


```{r}
ggplot(plinkPCA_kmeans_sub, aes(PC1.x,PC2.x, color = ethnic.x)) +
  geom_point(size = 3) +
  coord_equal() +
  theme_light() +
  coord_equal() +
  theme_light() +
  xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
  ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
  labs(title = "PCA on population structure, K-means")


```

```{r}
plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "3"] <- 'White'
plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "4"] <- 'Mixed'

plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "1"] <- 'Asian or Asian British(South, West, Central)'
plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "2"] <- 'Black or Black British'
plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "5"] <- 'Chinese'

# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "White"] <- 'Black or Black British'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Mixed"] <- 'Asian or Asian British(Chinese included)'
# 
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Black or Black British"] <- 'White'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Asian or Asian British(Chinese included)"] <- 'Mixed'
```

```{r}
ggplot(region_1, aes(PC1,PC2, color = ethnic)) +
  geom_point(size = 3) +
  coord_equal() +
  theme_light() +
  coord_equal() +
  theme_light() +
  xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
  ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
  labs(title = "PCA on population structure, real")
# plinkPCA$region <- region$X1
# # colnames(plinkPCA)[21] <- "pop"
# plinkPCA$col<- ifelse(plinkPCA$pop >= 0, 1, 0)
# plinkPCA$col<-as.factor(plinkPCA$col)

# plinkPCA1 <- subset(plinkPCA1, ethnic != 'NA')

# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Black or Black British"] <- 'White'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Mixed"] <- 'Mixed'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "White"] <- 'Asian or Asian British(Chinese included)'
# plinkPCA_kmeans_sub$ethnic.x[plinkPCA_kmeans_sub$ethnic.x == "Asian or Asian British(Chinese included)"] <- 'Black or Black British'

ggplot(plinkPCA_kmeans_sub, aes(PC1.x,PC2.x, color = ethnic.x)) +
  geom_point(size = 3) +
  coord_equal() +
  theme_light() +
  coord_equal() +
  theme_light() +
  xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
  ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
  labs(title = "PCA on population structure, K-means")


```

## Accuracy
```{r}
count = 0
for (i in 1:60042) {
  if (plinkPCA_kmeans_sub[i,22] == region_1[i,22]) {  ## plinkPCA2[i]$ethnic == region_1[i]$ethnic
    count = count + 1
  }
}

acc = count / 60042
acc
```
# Extract .fam
## load .fam
```{r}
fam <- read_table2("data_qc.fam",
                        col_names = FALSE)
fam$region <- km$cluster
```
## extract region = 1 out
In the case above,
1. AsianSWC, 2. Black 3. White 4. Mixed 5. Chinese
```{r}
fam1 <- fam[fam$region == 1,]
fam1 <- subset(fam1, select = -region)
colnames(fam1) <- c("FID","IID","Far","Mor","Gender","Phenotype")
write.table(fam1, file = "./data_AsianSWC.fam", row.names = FALSE, col.names = TRUE, quote = FALSE)
```

```{r}
plinkPCA_kmeans$ethnic[plinkPCA_kmeans$ethnic == "4"] <- 'White'
plinkPCA_kmeans$ethnic[plinkPCA_kmeans$ethnic == "1"] <- 'Mixed'

plinkPCA_kmeans$ethnic[plinkPCA_kmeans$ethnic == "2"] <- 'Asian or Asian British(Chinese included)'
plinkPCA_kmeans$ethnic[plinkPCA_kmeans$ethnic == "3"] <- 'Black or Black British'


ggplot(plinkPCA_kmeans, aes(PC1,PC2, color = ethnic)) +
  geom_point(size = 3) +
  coord_equal() +
  theme_light() +
  coord_equal() +
  theme_light() +
  xlab(paste0("PC1 (", signif(pve$pve[1],3), "%)")) +
  ylab(paste0("PC2 (",signif(pve$pve[2],3),"%)")) +
  labs(title = "PCA on population structure, ind = 66688, K-means")
```

## New Plan for METAL, 3.7
Try to delete the three columns and see if METAL can still work.
```{r}
dgi <- read_table2("D://Aarhus/Courses/Thesis/Project/Meta-analysis/METAL/GlucoseExample/DGI_three_regions.txt",
                        col_names = TRUE)
magic <- read_table2("D://Aarhus/Courses/Thesis/Project/Meta-analysis/METAL/GlucoseExample/magic_SARDINIA.tbl",
                     col_names = TRUE)

dgi_1 <- select(dgi, -c(10,11))
magic_1 <- select(magic, -c(11))

write.table(dgi_1, file = "D://Aarhus/Courses/Thesis/Project/Meta-analysis/METAL/GlucoseExample/DGI_three_regions_1.txt", row.names = FALSE, col.names = TRUE, quote = FALSE)
write.table(magic_1, file = "D://Aarhus/Courses/Thesis/Project/Meta-analysis/METAL/GlucoseExample/magic_SARDINIA_1.tbl", row.names = FALSE, col.names = TRUE, quote = FALSE)
```


## METAL Regenie 
Manhattan and qq-plot
```{r}
# install.packages("gap")
library(gap)
assoc_data <- read_table2(file = "METAANALYSIS_4Ancestries_V1.TBL", col_names = TRUE)
regenie <- read_table2(file = "data_regenie_Asian_urate_out_firth_2_Phenotype.regenie", col_names = TRUE)
regenie <- select(regenie, c(1,2,3))
names(regenie) <- c("CHROM","GENPOS","MarkerName")
assoc_data_1 <- merge(assoc_data, regenie, by = "MarkerName")
# manhattan(assoc_data)
# METAL_forestplot(assoc_data, all, rsid, package = "meta", split = FALSE)


# sum(-log10(assoc_data_1$`P-value`)>7)

assoc_data1 <- assoc_data_1[,c("CHROM","GENPOS","P-value")]
names(assoc_data1) <- c("CHR","BP","P")
assoc_data_sub <- assoc_data1
assoc_data_sub <- tidyr::unite(assoc_data_sub,"SNP",CHR,BP,sep=":",remove=FALSE)
names(assoc_data_sub) <- c("SNP","CHR","BP","P")
assoc_data_sub$P <-as.numeric(assoc_data_sub$P)
# manhattan(assoc_data_sub, logp=TRUE)
qq(assoc_data_sub$P, main = "Q-Q", xlim = c(0,22), ylim=c(0,7))
```

## Manhattan
```{r}
don <- assoc_data_sub %>% 
  
  # Compute chromosome size
  group_by(CHR) %>% 
  summarise(chr_len=max(BP)) %>% 
  
  # Calculate cumulative position of each chromosome
  mutate(tot=cumsum(chr_len)-chr_len) %>%
  select(-chr_len) %>%
  
  # Add this info to the initial dataset
  left_join(assoc_data_sub, ., by=c("CHR"="CHR")) %>%
  
  # Add a cumulative position of each SNP
  arrange(CHR, BP) %>%
  mutate( BPcum=BP+tot)
axisdf = don %>% group_by(CHR) %>% summarize(center=( max(BPcum) + min(BPcum) ) / 2 )
ggplot(don, aes(x=BPcum, y=-log10(P))) +
    
    # Show all points
    geom_point( aes(color=as.factor(CHR)), alpha=0.8, size=1.3) +
    geom_hline(yintercept = -log10(5e-8), color = "red", linetype = "dashed") + 
    geom_hline(yintercept = -log10(1e-5), color = "#E69F00", linetype = "dashed") + 
    scale_color_manual(values = rep(c("grey", "skyblue"), 22 )) +
    
    # custom X axis:
    scale_x_continuous( label = axisdf$CHR, breaks= axisdf$center ) +
    scale_y_continuous(expand = c(0, 0) ) +     # remove space between plot area and x axis
  
    # Custom the theme:
    theme_bw() +
    theme( 
      legend.position="none",
      panel.border = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    ) +
  labs(title = "Meta-analysis, UKBB, urate, Manhattan") +
  xlab("Chromosome") +
  NULL
```
